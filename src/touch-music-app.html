<link rel="import" href="../bower_components/polymer/polymer.html">
<!--<link rel="import" href="game-master.html">-->
<link rel="import" href="songs-set.html">
<link rel="import" href="keyboard-map.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="key-node.html">
<link rel="import" href="event-player.html">
<link rel="import" href="timer-ticker.html">
<link rel="import" href="synthesizer-player.html">
<link rel="import" href="music-instrument.html">
<link rel="import" href="octave-filter.html">

<dom-module id="touch-music-app">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>

        <synthesizer-player id="synthesizer">
            <music-instrument name="piano" base="../assets/piano/"></music-instrument>
        </synthesizer-player>


        <h2 id="button2" on-tap="startTicker">Play oldMacDonald</h2>

        <timer-ticker id="ticker" ms-per-tick="[[tempo]]" ticks="{{ticks}}"></timer-ticker>

		<octave-filter on-play="showTone" octave="{{jsonSong.globals.octave}}">
			<event-player id="musicSheeter" ticks-per-turn=50
						log="{{thisIsWhatWeNeedToMatchTheUsersPerformanceAgainst}}" ticks="[[ticks]]"
						input="[[jsonSong.songAsEvents]]" on-ready="musicPlayerReady">
				<songs-set id="libs" song-name="oldMacDonald" curr-song="{{jsonSong}}"></songs-set>
				<event-list-parser id="eParser" input="{{jsonSong.events}}" output="{{jsonSong.songAsEvents}}"></event-list-parser>
			</event-player>
		</octave-filter>
        <!--<game-master id="master" ></game-master>-->

		<!--<iron-ajax url="myKeySet.json" data-json="[[keyMap]]"></iron-ajax>-->
		<keyboard-map>
			<template is="dom-repeat" items="[[keysArray]]">
				<key-node letter$="[[item]]">
				<!--<key-mole></key-mole>-->
				<!--<key-hammer></key-hammer>-->
				</key-node>
			</template>
		</keyboard-map>

		<finger-position-map id="fingerPositionMap"></finger-position-map>
		<finger-move-to-tone-map id="fingerMoveToToneMap"></finger-move-to-tone-map>

		<keyboard-listener on-play_soon="playFingerMoveMusic" on-key-event="keyIsHit" key-set="[[keysArray]]" last-pressed="{{lastKey}}"></keyboard-listener>

	</template>

	<script>
		Polymer({
			is: 'touch-music-app',
			properties: {
				keysArray: {
					type: Array,
					value: function() {
						return [
							"`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "backspace",
							"tab", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\",
							"capslock", "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'", "enter",
							"shiftL", "z", "x", "c", "v", "b", "n", "m", ",", ".", "/", "shiftR",
							"ctrlL", "altL", "space", "altR", "ctrlR"
						]
					}
				},
				songAsEvents: {
					type: Array
				}
			},
			playFingerMoveMusic: function(e){
				var code = e.code;
				var fingerMovement = this.$.fingerPositionMap.translate(code);
				var tone = this.$.fingerMoveToToneMap.translate(fingerMovement);
			    this.$.synthesizer.playTone(tone);
			},
			showTone: function(e){
			    var note = e.detail.name.toUpperCase() + (e.detail.args ? e.detail.args[0] : "");
			    this.$.synthesizer.playTone(note);
			},
			showToneSoon: function(e){
				//from the event, i could get a series of properties, such that I had the event, and I could just ask:
				//e.code
				//e.fingerMovement
				//e.letter
				//e.tone
				var tone = e.detail.name.toUpperCase();
				var fingerMovement = this.$.fingerMoveToToneMap.translate(tone);
				var code = this.$.fingerPositionMap.translate(fingerMovement);
				var letter = this.$.codeToKeyMap.translate(code);
				var visualLetter = this.$$("key[letter="+letter+"]");
				visualLetter.show();
				this.$.synthesizer.playTone(note);
			},
			startTicker: function() {
                this.$.ticker.toggle();
            }
		});
	</script>
</dom-module>